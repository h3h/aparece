---
- name: Install uv
  become: yes
  become_user: "{{ create_user }}"
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "/home/{{ create_user }}/.local/bin/uv"
  when: create_user is defined

- name: Add uv to system PATH
  copy:
    dest: /etc/profile.d/uv.sh
    content: |
      export PATH="$HOME/.local/bin:$PATH"
    owner: root
    group: root
    mode: "0644"

- name: Install Python 3.12 via uv
  become: yes
  become_user: "{{ create_user }}"
  shell: "/home/{{ create_user }}/.local/bin/uv python install 3.12"
  args:
    creates: "/home/{{ create_user }}/.local/share/uv/python"
  when: create_user is defined

- name: Verify uv installation
  become: yes
  become_user: "{{ create_user }}"
  shell: "/home/{{ create_user }}/.local/bin/uv --version"
  register: uv_version
  changed_when: false
  when: create_user is defined

- name: Verify Python installation via uv
  become: yes
  become_user: "{{ create_user }}"
  shell: "/home/{{ create_user }}/.local/bin/uv run --python 3.12 python --version"
  register: python_version
  changed_when: false
  when: create_user is defined

- name: Display versions
  debug:
    msg: |
      uv installed: {{ uv_version.stdout }}
      Python installed: {{ python_version.stdout }}
  when: create_user is defined
