---
- name: Bootstrap Ubuntu 24.04 server
  hosts: localhost
  connection: local
  gather_facts: yes

  pre_tasks:
    - name: Verify Ubuntu 24.04
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version == "24.04"
        fail_msg: "This playbook is designed for Ubuntu 24.04 only"

    - name: Display target system info
      debug:
        msg: |
          Bootstrapping {{ ansible_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}

  roles:
    - role: base
      tags: [base]

    - role: security
      tags: [security]

    - role: python
      tags: [python]

    - role: ruby
      tags: [ruby]

    - role: duckdb
      tags: [duckdb]

    - role: postgresql
      tags: [postgresql]

    - role: redis
      tags: [redis]

    - role: awscli
      tags: [awscli]

  post_tasks:
    # - name: Configure SSH daemon (disables root login)
    #   template:
    #     src: security/templates/sshd_config.j2
    #     dest: /etc/ssh/sshd_config
    #     owner: root
    #     group: root
    #     mode: "0644"
    #     validate: "/usr/sbin/sshd -t -f %s"

    # - name: Allow SSH login for created user only
    #   lineinfile:
    #     path: /etc/ssh/sshd_config
    #     regexp: "^#?AllowUsers"
    #     line: "AllowUsers {{ create_user }}"
    #     validate: "/usr/sbin/sshd -t -f %s"
    #   when: create_user is defined

    # - name: Restart SSH
    #   systemd:
    #     name: ssh
    #     state: restarted
