#!/usr/bin/env bash
set -euo pipefail

# Aparece: Cloud Server Bootstrap CLI
# Bootstraps Ubuntu 24.04 servers with security hardening,
# then deploys app activation capabilities for on-demand software installation.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ANSIBLE_DIR="${SCRIPT_DIR}/ansible"
REMOTE_DIR="/opt/aparece/ansible"

log() {
    echo "[aparece] $*"
}

error() {
    echo "[aparece] ERROR: $*" >&2
    exit 1
}

usage() {
    cat <<EOF
Usage: $(basename "$0") <command> [args]

Commands:
    bootstrap [user@]host [options]    Bootstrap a fresh Ubuntu 24.04 server

Run '$(basename "$0") bootstrap --help' for bootstrap options.
EOF
    exit "${1:-0}"
}

bootstrap_usage() {
    cat <<EOF
Usage: $(basename "$0") bootstrap [user@]host [options]

Bootstrap an Ubuntu 24.04 cloud server with security hardening, then deploy
app activation capabilities for on-demand software installation.

Arguments:
    [user@]host         Target in SSH format (required)

Options:
    -k, --key PATH          Path to SSH private key (default: ~/.ssh/id_rsa)
    --create-user NAME      Create a sudo user with this name
    --set-hostname NAME     Set the hostname on the remote machine
    -c, --check             Run in Ansible check mode (dry run)
    -v, --verbose           Enable verbose output
    -h, --help              Show this help message

Examples:
    $(basename "$0") bootstrap root@192.168.1.100
    $(basename "$0") bootstrap admin@myserver.example.com --create-user myuser
    $(basename "$0") bootstrap ubuntu@10.0.0.5 -k ~/.ssh/cloud_key --set-hostname webserver
EOF
    exit "${1:-0}"
}

cmd_bootstrap() {
    # Default values
    local ssh_key="${HOME}/.ssh/id_rsa"
    local check_mode=""
    local verbose=""
    local create_user=""
    local set_hostname=""
    local ssh_target=""

    # Parse arguments
    if [[ $# -lt 1 ]]; then
        bootstrap_usage 1
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -k|--key)
                ssh_key="$2"
                shift 2
                ;;
            --create-user)
                create_user="$2"
                shift 2
                ;;
            --set-hostname)
                set_hostname="$2"
                shift 2
                ;;
            -c|--check)
                check_mode="--check"
                shift
                ;;
            -v|--verbose)
                verbose="-vvv"
                shift
                ;;
            -h|--help)
                bootstrap_usage 0
                ;;
            -*)
                error "Unknown option: $1"
                ;;
            *)
                if [[ -z "$ssh_target" ]]; then
                    ssh_target="$1"
                else
                    error "Unexpected argument: $1"
                fi
                shift
                ;;
        esac
    done

    # Validate required arguments
    if [[ -z "$ssh_target" ]]; then
        error "Target is required"
    fi

    if [[ ! -d "$ANSIBLE_DIR" ]]; then
        error "Ansible directory not found: $ANSIBLE_DIR"
    fi

    # Build SSH options
    local ssh_opts="-o StrictHostKeyChecking=accept-new -o BatchMode=yes"
    if [[ -f "$ssh_key" ]]; then
        ssh_opts="$ssh_opts -i $ssh_key"
    fi

    log "Target: ${ssh_target}"
    if [[ -n "$create_user" ]]; then
        log "Will create user: ${create_user}"
    fi
    if [[ -n "$set_hostname" ]]; then
        log "Will set hostname: ${set_hostname}"
    fi
    log "Checking SSH connectivity..."

    # Test SSH connection
    if ! ssh $ssh_opts "$ssh_target" "echo 'SSH connection successful'" 2>/dev/null; then
        error "Failed to connect to ${ssh_target}. Check your SSH key and host."
    fi

    log "SSH connection verified"
    log "Copying Ansible files to remote host..."

    # Ensure remote directory exists and copy ansible directory
    ssh $ssh_opts "$ssh_target" "mkdir -p /opt/aparece"
    rsync -az --delete \
        -e "ssh $ssh_opts" \
        "${ANSIBLE_DIR}/" \
        "${ssh_target}:${REMOTE_DIR}/"

    log "Installing aparece CLI on remote host..."
    scp $ssh_opts "${SCRIPT_DIR}/templates/aparece-remote.sh" "${ssh_target}:/usr/local/bin/aparece"
    ssh $ssh_opts "$ssh_target" "chmod +x /usr/local/bin/aparece"

    log "Installing Ansible on remote host (if needed)..."

    # Build extra vars for ansible
    local extra_vars=""
    if [[ -n "$create_user" ]]; then
        extra_vars="$extra_vars -e create_user=${create_user}"
    fi
    if [[ -n "$set_hostname" ]]; then
        extra_vars="$extra_vars -e set_hostname=${set_hostname}"
    fi

    # Install Ansible on remote if not present, then run playbook
    ssh $ssh_opts "$ssh_target" bash <<REMOTE_SCRIPT
set -euo pipefail

# Check if ansible is installed
if ! command -v ansible-playbook &>/dev/null; then
    echo "[aparece] Installing Ansible..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq ansible
fi

echo "[aparece] Running bootstrap playbook..."
cd "${REMOTE_DIR}"

ansible-playbook \
    ${verbose} \
    ${check_mode} \
    ${extra_vars} \
    playbooks/bootstrap.yml

echo "[aparece] Bootstrap complete!"
REMOTE_SCRIPT

    log "Done! Server bootstrapped and ready."
    log "SSH in and run 'aparece list' to see available apps."
    log "Then run 'sudo aparece activate <app>' to install software on demand."
}

# Main dispatch
if [[ $# -lt 1 ]]; then
    usage 1
fi

case "$1" in
    bootstrap)
        shift
        cmd_bootstrap "$@"
        ;;
    -h|--help|help)
        usage 0
        ;;
    *)
        error "Unknown command: $1. Run '$(basename "$0") --help' for usage."
        ;;
esac
