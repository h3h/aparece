#!/usr/bin/env bash
set -euo pipefail

# Aparece: Cloud Server Bootstrap CLI
# Bootstraps Ubuntu 24.04 servers with security hardening and development dependencies

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ANSIBLE_DIR="${SCRIPT_DIR}/ansible"
REMOTE_DIR="/tmp/aparece-ansible"

# Default values
SSH_KEY="${HOME}/.ssh/id_rsa"
CHECK_MODE=""
VERBOSE=""
CREATE_USER=""
SET_HOSTNAME=""

usage() {
    cat <<EOF
Usage: $(basename "$0") [user@]host [options]

Bootstrap an Ubuntu 24.04 cloud server with security hardening and dependencies.

Arguments:
    [user@]host         Target in SSH format (required)

Options:
    -k, --key PATH          Path to SSH private key (default: ~/.ssh/id_rsa)
    --create-user NAME      Create a sudo user with this name
    --set-hostname NAME     Set the hostname on the remote machine
    -c, --check             Run in Ansible check mode (dry run)
    -v, --verbose           Enable verbose output
    -h, --help              Show this help message

Examples:
    $(basename "$0") root@192.168.1.100
    $(basename "$0") admin@myserver.example.com --create-user myuser
    $(basename "$0") ubuntu@10.0.0.5 -k ~/.ssh/cloud_key
EOF
    exit "${1:-0}"
}

log() {
    echo "[aparece] $*"
}

error() {
    echo "[aparece] ERROR: $*" >&2
    exit 1
}

# Parse arguments
if [[ $# -lt 1 ]]; then
    usage 1
fi

# First positional argument is the target
SSH_TARGET=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -k|--key)
            SSH_KEY="$2"
            shift 2
            ;;
        --create-user)
            CREATE_USER="$2"
            shift 2
            ;;
        --set-hostname)
            SET_HOSTNAME="$2"
            shift 2
            ;;
        -c|--check)
            CHECK_MODE="--check"
            shift
            ;;
        -v|--verbose)
            VERBOSE="-vvv"
            shift
            ;;
        -h|--help)
            usage 0
            ;;
        -*)
            error "Unknown option: $1"
            ;;
        *)
            if [[ -z "$SSH_TARGET" ]]; then
                SSH_TARGET="$1"
            else
                error "Unexpected argument: $1"
            fi
            shift
            ;;
    esac
done

# Validate required arguments
if [[ -z "$SSH_TARGET" ]]; then
    error "Target is required"
fi

if [[ ! -d "$ANSIBLE_DIR" ]]; then
    error "Ansible directory not found: $ANSIBLE_DIR"
fi

# Build SSH options
SSH_OPTS="-o StrictHostKeyChecking=accept-new -o BatchMode=yes"
if [[ -f "$SSH_KEY" ]]; then
    SSH_OPTS="$SSH_OPTS -i $SSH_KEY"
fi

log "Target: ${SSH_TARGET}"
if [[ -n "$CREATE_USER" ]]; then
    log "Will create user: ${CREATE_USER}"
fi
if [[ -n "$SET_HOSTNAME" ]]; then
    log "Will set hostname: ${SET_HOSTNAME}"
fi
log "Checking SSH connectivity..."

# Test SSH connection
if ! ssh $SSH_OPTS "$SSH_TARGET" "echo 'SSH connection successful'" 2>/dev/null; then
    error "Failed to connect to ${SSH_TARGET}. Check your SSH key and host."
fi

log "SSH connection verified"
log "Copying Ansible files to remote host..."

# Copy ansible directory to remote
rsync -az --delete \
    -e "ssh $SSH_OPTS" \
    "${ANSIBLE_DIR}/" \
    "${SSH_TARGET}:${REMOTE_DIR}/"

log "Installing Ansible on remote host (if needed)..."

# Build extra vars for ansible
EXTRA_VARS=""
if [[ -n "$CREATE_USER" ]]; then
    EXTRA_VARS="$EXTRA_VARS -e create_user=${CREATE_USER}"
fi
if [[ -n "$SET_HOSTNAME" ]]; then
    EXTRA_VARS="$EXTRA_VARS -e set_hostname=${SET_HOSTNAME}"
fi

# Install Ansible on remote if not present, then run playbook
ssh $SSH_OPTS "$SSH_TARGET" bash <<REMOTE_SCRIPT
set -euo pipefail

# Check if ansible is installed
if ! command -v ansible-playbook &>/dev/null; then
    echo "[aparece] Installing Ansible..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq ansible
fi

echo "[aparece] Running Ansible playbook..."
cd "${REMOTE_DIR}"

ansible-playbook \
    ${VERBOSE} \
    ${CHECK_MODE} \
    ${EXTRA_VARS} \
    playbooks/bootstrap.yml

echo "[aparece] Bootstrap complete!"
REMOTE_SCRIPT

log "Cleaning up remote files..."
ssh $SSH_OPTS "$SSH_TARGET" "rm -rf ${REMOTE_DIR}"

log "Done! Server has been bootstrapped."
